<!doctype html>
<meta charset="utf-8">
<title>Tatkal Agent ‚Äì Schedule Booking Reminders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* Global Styles */
body {
  font-family: system-ui, -apple-system, sans-serif;
  margin: 0;
  padding: 20px;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
  line-height: 1.6;
  background: #f5f7fa;
  color: #333;
}

/* Typography */
h1, h3 {
  text-align: center;
  color: #2c3e50;
  margin-bottom: 30px;
  margin-top: 20px;
}

h1 {
  font-size: 2.2em;
  margin-bottom: 10px;
}

/* Info Banner */
.info-banner {
  background: linear-gradient(135deg, #3498db, #2980b9);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 30px;
  text-align: center;
}

.info-banner h2 {
  margin: 0 0 10px;
  font-size: 1.3em;
}

.info-banner p {
  margin: 8px 0;
  opacity: 0.95;
}

.reminder-timeline {
  background: #e8f4fd;
  border: 2px solid #3498db;
  border-radius: 10px;
  padding: 20px;
  margin: 20px 0;
}

.reminder-timeline h4 {
  color: #2980b9;
  margin: 0 0 15px;
  font-size: 1.1em;
}

.timeline-item {
  display: flex;
  align-items: center;
  margin: 12px 0;
  padding: 8px;
  background: white;
  border-radius: 6px;
}

.timeline-icon {
  background: #3498db;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  margin-right: 12px;
  flex-shrink: 0;
}

.timeline-content {
  flex-grow: 1;
}

.timeline-time {
  font-weight: 600;
  color: #2980b9;
}

.timeline-desc {
  font-size: 14px;
  color: #666;
  margin-top: 2px;
}

/* Form Container */
form {
  background: white;
  padding: 32px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  margin-bottom: 30px;
}

/* Required field indicator */
.required::after {
  content: " *";
  color: #e74c3c;
  font-weight: bold;
}

/* Label Styles */
label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 8px;
  margin-top: 4px;
  color: #555;
}

/* Input Styles */
input, select, textarea {
  width: 100%;
  padding: 12px 16px;
  margin-bottom: 20px;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  font-size: 15px;
  font-family: inherit;
  transition: all 0.3s ease;
  background: #fff;
  box-sizing: border-box;
}

input:focus, select:focus, textarea:focus {
  border-color: #3498db;
  outline: none;
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

input:hover, select:hover {
  border-color: #bdc3c7;
}

/* Required field styling */
input:required, select:required {
  border-left: 4px solid #e67e22;
}

input:required:valid, select:required:valid {
  border-left: 4px solid #27ae60;
}

/* Small text under inputs */
small {
  display: block;
  color: #7f8c8d;
  font-size: 12px;
  margin-top: -15px;
  margin-bottom: 15px;
  padding-left: 4px;
}

/* Grid Layout */
.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-bottom: 24px;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 16px;
}

/* Button Styles */
button {
  padding: 14px 24px;
  border-radius: 8px;
  border: none;
  background: #3498db;
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 12px;
  margin-bottom: 8px;
  font-family: inherit;
}

button:hover {
  background: #2980b9;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

#addPassenger {
  background: #27ae60;
  margin-bottom: 20px;
}

#addPassenger:hover {
  background: #229954;
}

/* Passenger Cards */
.passenger-card {
  border: 2px solid #e8ecef;
  border-radius: 12px;
  padding: 24px;
  margin: 24px 0;
  background: #fafbfc;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  transition: box-shadow 0.3s ease;
}

.passenger-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.passenger-card h4 {
  margin: 0 0 20px;
  font-size: 1.2em;
  color: #2c3e50;
  padding-bottom: 8px;
  border-bottom: 2px solid #ecf0f1;
}

/* Remove Button */
.remove-btn {
  background: #e74c3c;
  margin-top: 16px;
  padding: 10px 20px;
}

.remove-btn:hover {
  background: #c0392b;
}

/* Notification Section */
.notification-section {
  background: #f8f9fc;
  border: 2px solid #6c63ff;
  border-radius: 10px;
  padding: 20px;
  margin-top: 32px;
}

.notification-section h4 {
  color: #6c63ff;
  margin: 0 0 15px;
  display: flex;
  align-items: center;
}

.notification-section h4::before {
  content: "üì¢";
  margin-right: 8px;
}

.notification-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 16px;
}

.whatsapp-input {
  border-left: 4px solid #25D366;
}

.telegram-input {
  border-left: 4px solid #0088cc;
}

/* Submit button */
button[type="submit"] {
  background: #e67e22;
  width: 100%;
  padding: 16px;
  font-size: 16px;
  margin-top: 24px;
}

button[type="submit"]:hover {
  background: #d35400;
}

/* Result Section */
pre {
  background: #1e1e1e;
  color: #00ff99;
  padding: 20px;
  border-radius: 8px;
  overflow-x: auto;
  margin-top: 20px;
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 14px;
  line-height: 1.4;
}

/* Alert for no notification method */
.no-notification-alert {
  background: #fff3cd;
  border: 1px solid #ffc107;
  color: #856404;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 16px;
  display: none;
}

/* Responsive Design */
@media (max-width: 768px) {
  body {
    padding: 15px;
  }
  
  form {
    padding: 24px;
  }
  
  .row, .grid, .notification-row {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  input, select {
    padding: 14px;
    font-size: 16px;
  }

  .timeline-item {
    flex-direction: column;
    text-align: center;
  }
  
  .timeline-icon {
    margin-right: 0;
    margin-bottom: 8px;
  }
}
</style>

<h1>üöÇ Tatkal Booking Reminder</h1>

<div class="info-banner">
  <h2>Smart Tatkal Reminders</h2>
  <p>Get perfectly timed WhatsApp & Telegram alerts for your train booking</p>
  <p><strong>T-10:</strong> 10 minutes before booking opens ‚Ä¢ <strong>T-0:</strong> Booking window opens</p>
</div>

<form id="f">
  <div class="reminder-timeline">
    <h4>üìÖ How Your Reminders Work</h4>
    <div class="timeline-item">
      <div class="timeline-icon">T-10</div>
      <div class="timeline-content">
        <div class="timeline-time">10 Minutes Before Booking</div>
        <div class="timeline-desc">Get ready alert via WhatsApp/Telegram - prepare your IRCTC login and passenger details</div>
      </div>
    </div>
    <div class="timeline-item">
      <div class="timeline-icon">T-0</div>
      <div class="timeline-content">
        <div class="timeline-time">Booking Window Opens</div>
        <div class="timeline-desc">Immediate alert when Tatkal booking starts (10:00 AM for AC, 11:00 AM for Non-AC)</div>
      </div>
    </div>
  </div>

  <div class="row">
    <div>
      <label class="required">üìÖ Date of Journey</label>
      <input type="date" name="date" required id="dateInput">
      <small>Tatkal opens 1 day before journey date</small>
    </div>
    <div>
      <label class="required">‚è∞ Tatkal Type</label>
      <select name="tatkalType" id="tatkalTypeSelect" required>
        <option value="">Select Tatkal Type</option>
        <option value="AC">AC Tatkal (Opens 10:00 AM)</option>
        <option value="NONAC">Non-AC Tatkal (Opens 11:00 AM)</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label class="required">üöÇ Train Number</label>
      <input name="train" id="trainInput" required placeholder="12345">
      <small id="trainName"></small>
    </div>
    <div>
      <label class="required">üé´ Class</label>
      <select name="class" required>
        <option value="">Select Class</option>
        <option value="1A">First AC (1A)</option>
        <option value="2A">Second AC (2A)</option>
        <option value="3A">Third AC (3A)</option>
        <option value="SL">Sleeper (SL)</option>
        <option value="CC">Chair Car (CC)</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label class="required">üöâ From (Station Code)</label>
      <input name="from" id="fromInput" required placeholder="NDLS" style="text-transform: uppercase">
      <small>Enter IRCTC station code (e.g., NDLS for New Delhi)</small>
    </div>
    <div>
      <label class="required">üèÅ To (Station Code)</label>
      <input name="to" id="toInput" required placeholder="HWH" style="text-transform: uppercase">
      <small>Enter IRCTC station code (e.g., HWH for Howrah)</small>
    </div>
  </div>

  <h3>üë• Passengers (Max 4 for Tatkal)</h3>
  <div id="passengers"></div>
  <button type="button" id="addPassenger">+ Add Passenger</button>

  <div class="notification-section">
    <h4>Notification Preferences (Optional)</h4>
    <div class="no-notification-alert" id="noNotificationAlert">
      ‚ö†Ô∏è Note: Without notification settings, you won't receive any reminders. At least one notification method is recommended.
    </div>
    
    <div class="notification-row">
      <div>
        <label>üì± WhatsApp Number</label>
        <input name="whatsappTo" class="whatsapp-input" placeholder="whatsapp:+919876543210">
        <small>Format: whatsapp:+91XXXXXXXXXX</small>
      </div>
      <div>
        <label>üì® Telegram Chat ID</label>
        <input name="telegramTo" class="telegram-input" placeholder="@username or chat_id">
        <small>Your Telegram username (@username) or chat ID</small>
      </div>
    </div>
    
    <small style="color: #666; font-style: italic;">
      üí° You can provide either WhatsApp or Telegram or both. Leave blank if you don't want notifications.
    </small>
  </div>

  <button type="submit">üîî Schedule My Tatkal Reminders</button>
</form>

<div id="reminderPreview" style="display:none; background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin: 20px 0;">
  <h4 style="color: #856404;">üìã Your Reminder Schedule</h4>
  <div id="scheduleDetails"></div>
</div>

<h3>üì± System Response</h3>
<pre id="out"></pre>

<script>
  // ====== Date: restrict to today ‚Üí +30 days ======
  const dateInput = document.getElementById('dateInput');
  const today = new Date();
  const maxDate = new Date();
  maxDate.setDate(today.getDate() + 30);
  dateInput.min = today.toISOString().split('T')[0];
  dateInput.max = maxDate.toISOString().split('T')[0];

  // ====== Show reminder schedule when date/type changes ======
  function updateReminderSchedule() {
    const selectedDate = dateInput.value;
    const tatkalType = document.getElementById('tatkalTypeSelect').value;
    
    if (selectedDate && tatkalType) {
      const journeyDate = new Date(selectedDate);
      const bookingDate = new Date(journeyDate);
      bookingDate.setDate(bookingDate.getDate() - 1);
      
      const bookingTime = tatkalType === 'AC' ? '10:00 AM' : '11:00 AM';
      const reminderTime = tatkalType === 'AC' ? '9:50 AM' : '10:50 AM';
      
      const preview = document.getElementById('reminderPreview');
      const details = document.getElementById('scheduleDetails');
      
      details.innerHTML = `
        <p><strong>Journey Date:</strong> ${journeyDate.toDateString()}</p>
        <p><strong>Booking Date:</strong> ${bookingDate.toDateString()}</p>
        <p><strong>T-10 Reminder:</strong> ${reminderTime} - Get Ready Alert</p>
        <p><strong>T-0 Alert:</strong> ${bookingTime} - Booking Opens!</p>
      `;
      
      preview.style.display = 'block';
    }
  }
  
  dateInput.addEventListener('change', updateReminderSchedule);
  document.getElementById('tatkalTypeSelect').addEventListener('change', updateReminderSchedule);

  // ====== Check notification settings ======
  function checkNotificationSettings() {
    const whatsapp = document.querySelector('input[name="whatsappTo"]').value;
    const telegram = document.querySelector('input[name="telegramTo"]').value;
    const alert = document.getElementById('noNotificationAlert');
    
    if (!whatsapp && !telegram) {
      alert.style.display = 'block';
    } else {
      alert.style.display = 'none';
    }
  }
  
  document.querySelector('input[name="whatsappTo"]').addEventListener('input', checkNotificationSettings);
  document.querySelector('input[name="telegramTo"]').addEventListener('input', checkNotificationSettings);

  // ====== Passengers ======
  const passengersDiv = document.getElementById('passengers');
  const addPassengerBtn = document.getElementById('addPassenger');
  let passengerCount = 0;
  const MAX_PASSENGERS = 4;

  function addPassenger(p = {}) {
    if (passengerCount >= MAX_PASSENGERS) {
      alert("Maximum 4 passengers allowed in Tatkal booking");
      return;
    }
    passengerCount++;
    const div = document.createElement('div');
    div.className = 'passenger-card';
    div.innerHTML = `
      <h4>üë§ Passenger ${passengerCount}</h4>
      <div class="grid">
        <div>
          <label class="required">Full Name (as per ID)</label>
          <input required name="p_name_${passengerCount}" value="${p.name || ''}" placeholder="Enter full name">
        </div>
        <div>
          <label class="required">Age</label>
          <input type="number" required name="p_age_${passengerCount}" value="${p.age || ''}" min="5" max="120">
        </div>
      </div>
      <div class="grid">
        <div>
          <label class="required">Gender</label>
          <select name="p_gender_${passengerCount}" required>
            <option value="">Select Gender</option>
            <option value="M" ${p.gender == 'M' ? 'selected' : ''}>Male</option>
            <option value="F" ${p.gender == 'F' ? 'selected' : ''}>Female</option>
          </select>
        </div>
        <div>
          <label>Berth Preference</label>
          <select name="p_berth_${passengerCount}">
            <option value="LB">Lower Berth (LB)</option>
            <option value="MB">Middle Berth (MB)</option>
            <option value="UB">Upper Berth (UB)</option>
            <option value="SL">Side Lower (SL)</option>
            <option value="SU">Side Upper (SU)</option>
          </select>
        </div>
      </div>
      <div class="grid">
        <div>
          <label>ID Type</label>
          <input name="p_idType_${passengerCount}" value="${p.idType || ''}" placeholder="Aadhaar/PAN/Voter ID">
        </div>
        <div>
          <label>ID Number</label>
          <input name="p_idNumber_${passengerCount}" value="${p.idNumber || ''}" placeholder="Enter ID number">
        </div>
      </div>
      <button type="button" class="remove-btn" onclick="this.parentElement.remove(); passengerCount--;">‚ùå Remove Passenger</button>
    `;
    passengersDiv.appendChild(div);
  }
  addPassengerBtn.onclick = () => addPassenger();

  // Auto-add first passenger
  addPassenger();

  // ====== Train Lookup ======
  const trainInput = document.getElementById('trainInput');
  const trainNameLabel = document.getElementById('trainName');
  trainInput.addEventListener('input', () => {
    const trainNum = trainInput.value;
    if (trainNum === "12345") trainNameLabel.textContent = "Howrah Rajdhani Express";
    else if (trainNum === "12301") trainNameLabel.textContent = "Kolkata Rajdhani Express";
    else if (trainNum === "12951") trainNameLabel.textContent = "Mumbai Rajdhani Express";
    else if (trainNum === "12302") trainNameLabel.textContent = "Kolkata Rajdhani Express";
    else trainNameLabel.textContent = "";
  });

  // Make station codes uppercase
  document.getElementById('fromInput').addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase();
  });
  document.getElementById('toInput').addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase();
  });

  // Initialize notification check
  checkNotificationSettings();

  const out = document.getElementById('out');
  document.getElementById('f').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);

    const passengers = [];
    for (let i = 1; i <= MAX_PASSENGERS; i++) {
      if (fd.get(`p_name_${i}`)) {
        passengers.push({
          name: fd.get(`p_name_${i}`),
          age: parseInt(fd.get(`p_age_${i}`)),
          gender: fd.get(`p_gender_${i}`),
          berth: fd.get(`p_berth_${i}`),
          idType: fd.get(`p_idType_${i}`),
          idNumber: fd.get(`p_idNumber_${i}`)
        });
      }
    }

    // Check if at least one passenger exists
    if (passengers.length === 0) {
      alert("‚ùå Please add at least one passenger");
      return;
    }

    const journeyDate = new Date(fd.get('date'));
    const bookingDate = new Date(journeyDate);
    bookingDate.setDate(bookingDate.getDate() - 1);
    
    const whatsappTo = fd.get('whatsappTo');
    const telegramTo = fd.get('telegramTo');
    
    const payload = {
      date: fd.get('date'),
      train: fd.get('train'),
      from: fd.get('from').toUpperCase(),
      to: fd.get('to').toUpperCase(),
      class: fd.get('class'),
      tatkalType: fd.get('tatkalType'),
      passengers,
      notifications: {
        whatsapp: whatsappTo || null,
        telegram: telegramTo || null
      },
      bookingDate: bookingDate.toISOString().split('T')[0],
      reminderScheduled: true
    };

    // show JSON on screen
    out.textContent = JSON.stringify(payload, null, 2);

    // === send to backend ===
    try {
      const res = await fetch("http://localhost:4567/api/tatkal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      console.log("Reminders scheduled:", data);
      
      let successMessage = "‚úÖ Tatkal reminders scheduled successfully!";
      if (whatsappTo && telegramTo) {
        successMessage += " You'll receive alerts on both WhatsApp and Telegram.";
      } else if (whatsappTo) {
        successMessage += " You'll receive WhatsApp alerts.";
      } else if (telegramTo) {
        successMessage += " You'll receive Telegram alerts.";
      } else {
        successMessage += " No notification methods configured - reminders saved without alerts.";
      }
      
      alert(successMessage);
    } catch(err) {
      console.error("API error", err);
      alert("‚ùå Error scheduling reminders. Please try again.");
    }

    // Reset form after 3 seconds
    setTimeout(() => {
      e.target.reset();
      passengersDiv.innerHTML = "";
      passengerCount = 0;
      addPassenger(); // Add first passenger again
      document.getElementById('reminderPreview').style.display = 'none';
      checkNotificationSettings();
    }, 3000);
  });
</script>
